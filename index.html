<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #chat {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 10px;
        }
        .message {
            margin: 5px 0;
        }
        .file-link {
            color: blue;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>WebSocket Chat</h1>
    <input id='userId' placeholder='Введите свой id' />
    <input id='message' placeholder='Введите сообщение' />
    <input type='file' id='fileInput' />
    <button onclick='sendMessage()'>Отправить</button>
    <div id='chat'></div>

    <script>
        const userId = document.getElementById('userId');
        const messageInput = document.getElementById('message');
        const fileInput = document.getElementById('fileInput');
        const chat = document.getElementById('chat');
        let websocket;

        function connect() {
            websocket = new WebSocket(`ws://localhost:8000/ws/${userId.value}`);
            websocket.onmessage = (event) => {
                const messageData = JSON.parse(event.data);
                const messageElement = document.createElement('div');
                messageElement.className = 'message';

                if (messageData.type === 'text') {
                    messageElement.textContent = messageData.content;
                } else if (messageData.type === 'file') {
                    const fileLink = document.createElement('a');
                    fileLink.href = `data:application/octet-stream;base64,${messageData.content}`;
                    fileLink.download = messageData.filename;
                    fileLink.textContent = `Скачать ${messageData.filename}`;
                    fileLink.className = 'file-link';
                    messageElement.appendChild(fileLink);
                }

                chat.appendChild(messageElement);
                chat.scrollTop = chat.scrollHeight;
            };

            websocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                alert('Ошибка WebSocket: ' + error.message);
            };

            websocket.onclose = () => {
                alert('Соединение закрыто. Пожалуйста, обновите страницу для повторного подключения.');
            };
        }

        function sendMessage() {
            if (websocket) {
                const message = messageInput.value;
                if (message) {
                    websocket.send(JSON.stringify({ type: 'text', content: message }));
                    messageInput.value = '';
                }

                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const base64Data = event.target.result.split(',')[1];
                        websocket.send(JSON.stringify({ type: 'file', content: base64Data, filename: file.name }));
                        fileInput.value = '';
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        userId.addEventListener('change', connect);
    </script>
</body>
</html>